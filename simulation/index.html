<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Simulation – Lennings</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1 1'><rect fill='%236af' width='1' height='1'/></svg>">
<style>
  :root { --bg: #1a1a1a; --fg: #e0e0e0; --muted: #888; --accent: #6af; --panel: #252525; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--fg); margin: 0; padding: 1rem; }
  a { color: var(--accent); }
  h1 { font-size: 1.25rem; margin: 0 0 1rem; }
  section { margin-bottom: 1.5rem; }
  .panel { background: var(--panel); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
  label { display: block; margin-bottom: 0.25rem; color: var(--muted); font-size: 0.85rem; }
  input[type="number"], input[type="text"], select { width: 100%; max-width: 12rem; padding: 0.4rem; background: var(--bg); border: 1px solid #444; color: var(--fg); border-radius: 4px; }
  input[type="file"] { margin-top: 0.25rem; }
  button { padding: 0.5rem 1rem; background: var(--accent); color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.secondary { background: #444; color: var(--fg); }
  .row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
  .row > * { flex: 0 0 auto; }
  #results { margin-top: 1rem; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  th, td { padding: 0.4rem 0.75rem; text-align: left; border-bottom: 1px solid #333; }
  th { color: var(--muted); font-weight: 500; }
  .status { color: var(--muted); font-size: 0.85rem; margin-top: 0.5rem; }
  .error { color: #f66; }
  .nav { margin-bottom: 1rem; }
  #progressPanel { display: none; margin-top: 1rem; }
  #progressPanel.running { display: block; }
  .progress-bar-wrap { height: 12px; background: #333; border-radius: 6px; overflow: hidden; margin: 0.5rem 0; }
  .progress-bar { height: 100%; background: var(--accent); border-radius: 6px; transition: width 0.15s; }
  .progress-stats { font-family: monospace; font-size: 0.9rem; margin-top: 0.25rem; }
  .params-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
  .param-row { display: grid; grid-template-columns: 1fr auto auto; gap: 0.5rem; align-items: center; }
  .param-row label.param-name { margin: 0; min-width: 0; }
  .param-row input.start { width: 4rem; }
  .param-row input.window { width: 3.5rem; }
  .params-section { margin-bottom: 1rem; }
  .params-section h3 { font-size: 0.9rem; margin: 0 0 0.5rem; color: var(--muted); }
  .play-run-btn { padding: 0.2rem 0.5rem; font-size: 0.8rem; cursor: pointer; background: var(--accent); color: #000; border: none; border-radius: 4px; }
  .play-run-btn:hover { opacity: 0.9; }
  .replay-player { margin-top: 0.5rem; }
  .replay-player__controls { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; }
  .replay-player__btn { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
  .replay-player__status { font-family: monospace; font-size: 0.85rem; color: var(--muted); margin-left: 0.25rem; }
  .replay-player__speed-label { margin: 0; font-size: 0.8rem; color: var(--muted); }
  .replay-player__speed { width: auto; max-width: 4rem; padding: 0.2rem; }
  .replay-player__slider { display: block; width: 100%; max-width: 20rem; margin-top: 0.5rem; }
  .replay-detail-row td { padding: 0.5rem 0.75rem; vertical-align: top; border-bottom: 1px solid #333; }
  .replay-row-content { padding: 0.5rem 0; }
  .replay-row-canvas { border-radius: 6px; margin-bottom: 0.5rem; }
  .replay-row-controls { margin-top: 0.25rem; }
</style>
<body>
  <nav class="nav"><a href="../">← Back to Lennings</a></nav>
  <h1>Simulation</h1>
  <p class="status">Headless runs: load an image, set parameters, run single or sweep. No rendering.</p>

  <section class="panel">
    <h2 style="margin:0 0 0.75rem; font-size:1rem;">Image</h2>
    <label>Resource image (particles feed on it)</label>
    <input type="file" id="imageFile" accept="image/*">
    <span class="status" id="imageStatus">Default: zenarnie.jpg (or choose a file).</span>
  </section>

  <section class="panel" id="paramsPanel">
    <h2 style="margin:0 0 0.75rem; font-size:1rem;">Sweepable parameters</h2>
    <p class="status">Start = value for this run. Window = range for future param sweep (start ± window).</p>
    <div id="sweepableParams"></div>
  </section>

  <section class="panel" id="progressPanel">
    <h2 style="margin:0 0 0.5rem; font-size:1rem;">Progress</h2>
    <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
    <div class="progress-stats" id="progressStats">—</div>
  </section>

  <section class="panel">
    <h2 style="margin:0 0 0.75rem; font-size:1rem;">Run</h2>
    <div class="row">
      <div>
        <label>Spawn center X</label>
        <input type="number" id="spawnX" value="-24" step="1">
      </div>
      <div>
        <label>Spawn center Y</label>
        <input type="number" id="spawnY" value="29" step="1">
      </div>
      <div>
        <label>Spawn count</label>
        <input type="number" id="spawnCount" value="256" min="1" max="2048" step="1">
      </div>
      <div>
        <label>Steps</label>
        <input type="number" id="numSteps" value="500" min="100" step="100">
      </div>
      <div>
        <label>Sample every N steps</label>
        <input type="number" id="sampleInterval" value="100" min="0" step="10">
      </div>
      <div>
        <label>Replay: capture every N steps</label>
        <input type="number" id="captureInterval" value="10" min="1" step="1" title="Finer = more replay frames (e.g. 10 → 50 frames for 500 steps)">
      </div>
      <div>
        <label>Seed (optional)</label>
        <input type="text" id="seed" placeholder="e.g. 12345" title="Set for reproducible runs (same params + seed => same result)">
      </div>
    </div>
    <div class="row" style="margin-top:0.75rem;">
      <div>
        <label>Mode</label>
        <select id="runMode">
          <option value="single">Single run</option>
          <option value="sweep">Sweep (spawn centers)</option>
        </select>
      </div>
      <div id="sweepOptions" style="display:none;">
        <label>Sweep: grid size (e.g. 3 = 3×3)</label>
        <input type="number" id="sweepGrid" value="2" min="2" max="5">
      </div>
    </div>
    <div style="margin-top:1rem;">
      <button id="runBtn">Run</button>
      <button type="button" class="secondary" id="exportConfigBtn">Export config</button>
      <button type="button" class="secondary" id="importConfigBtn">Import config</button>
      <span class="status" id="runStatus"></span>
    </div>
    <div id="importConfigArea" style="display:none; margin-top:0.5rem;">
      <label>Paste JSON config</label>
      <textarea id="importConfigPaste" rows="4" style="width:100%; max-width:32rem; background:var(--bg); border:1px solid #444; color:var(--fg); border-radius:4px; padding:0.4rem; font-family:monospace; font-size:0.85rem;"></textarea>
      <div style="margin-top:0.25rem;">
        <button type="button" id="importConfigApply">Apply &amp; close</button>
        <button type="button" class="secondary" id="importConfigCancel">Cancel</button>
      </div>
    </div>
    <div id="progressInline" class="status" style="margin-top:0.5rem; display:none;"></div>
  </section>

  <section class="panel" id="playbackPanel" style="display:none;">
    <h2 style="margin:0 0 0.75rem; font-size:1rem;">Playback</h2>
    <p class="status">Replay saved simulation. Use controls to analyze frame-by-frame.</p>
    <div id="playbackContainer" style="position:relative; display:inline-block; min-height:256px;">
      <!-- Context canvas is moved here when Play is pressed -->
    </div>
    <div id="playbackControls"></div>
    <div style="margin-top:0.5rem;">
      <button type="button" class="secondary" id="playbackCloseBtn">Close</button>
    </div>
  </section>

  <section class="panel">
    <h2 style="margin:0 0 0.75rem; font-size:1rem;">Results</h2>
    <div id="results"></div>
  </section>

  <script src="../twgl.min.js"></script>
  <script src="../lenia.js"></script>
  <script src="runner.js"></script>
  <script src="replay-player.js"></script>
  <script src="simulation.js"></script>
</body>
</html>
